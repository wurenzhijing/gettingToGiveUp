# JVM 内存模型

## 内存模型

Java内存模型， 指的是Java程序的运行时的内存的模型，java程序试运行在Java虚拟机之后的， 因此 Java内存模型也就是Java虚拟机的运行时内存模型

![](http://gityuan.com/images/jvm/jvm_memory_1.png)

运行时内存模型分为 ： 

 - 线程私有
 	- 程序计数器 : 记录正在执行的虚拟机字节码的地址
 	- 虚拟机栈 ： 方法执行的内存区， 每个方法执行时会在虚拟机栈中创建栈桢
 	- 本地方法区 ： 虚拟机的native方法执行的内存区

 - 共享数据
 	- Java堆 : 对象分配内存的区域
 	- 方法区 ： 存放类信息、常量、静态变量、编译器编译后的代码等数据
 		- 常量池： 存放编译器生成的各种字面量和符号引用， 是方法区的一部分

## 详细模型

![](http://gityuan.com/images/jvm/stack_heap_info.png)


#### 程序计数器PC

程序计数器PC ， 当前线程所执行的字节码行号指示器。 每个线程都有自己计数器， 是私有内存空间， 该区域是整个内存中较小的一块

当线程在执行一个Java方法时， PC计数器记录的是正在执行的虚拟器字节码的地址 ， 当线程正在执行一个Native方法时 ， PC计数器则为空

#### 虚拟机栈

虚拟机栈， 生命周期与线程相同 ， 是Java方法执行的内存模型 。 每个方法（不包含native方法）执行的同事都会创建一个栈桢结构， 方法执行过程， 对应着虚拟机栈的入栈到出栈的过程

##### 栈桢结构

栈桢时用于支持虚拟机进行方法执行的数据结构， 是属性运行时数据区的虚拟机栈的占元素 。

栈桢包括 ： 

 - 局部变量表 （locals大小，编译器确定） ， 一组变量存储空间 ， 容量以slot为最小单位
 - 操作栈（stack大小， 编译七确定）， 操作栈元素的数据类型必须与字节码指令序列严格匹配
 - 动态连接， 指向运行时常量池中该栈桢所属方法的引用， 为了动态连接使用
 	- 前面的解析过程实际是静态解析
 	- 对于运行期转化为直接引用，成为动态解析
 - 方法返回地址
    - 正常退出， 执行引擎到方法返回的字节码 ， 将返回值传递给调用者
    - 异常退出， 遇到Exception， 并且方法未捕捉异常， 那么不会有任何返回值
 - 额外附加信息 ， 虚拟机规范没有明确， 由具体虚拟机实现

虚拟机规范规定该区域有两种异常：

 - StackOverFlowError ： 当线程请求栈深度超出虚拟机栈所允许的深度时抛出
 - PutOfMemeryError ： 当Java虚拟机动态扩展到无法申请足够内存时抛出

#### 本地方法栈

本地方法栈是为虚拟机使用到的Native方法提供内存空间， 而前面说的虚拟机栈是为Java方法提供内存空间

有些虚拟机 直接把本地方法栈和虚拟机栈 合二为一 ， 比如 Sun HotSpot虚拟机

Java虚拟机规范规定该区域可抛出 StackOverFlowError 和 OutOfMemoryError

#### Java堆

Java堆， 是Java虚拟机管理的最大的一块内存， 也是GC的主战场， 里面存放的是几乎所有的对象实例和数组数据 。  JIT编译器有栈上分配、标量替换等优化技术，导致部分对象实例不再Java堆，而是在栈内存

 - 从内存回收角度 ， Java堆被分为新生代 和 老年代 ， 这样更好的利于内存回收
 - 从内存分配角度 ， Java堆被分为 线程私有的分配缓冲区 ， TLAB， 这样更快的分配内存

![](http://gityuan.com/images/jvm/java_object.png)

对于填充数据不是一定存在的 ， 仅仅是为了字节对齐 。 HotSpot VM 自动内存管理要求对象的起始地址必须是8字节的整数倍 。 对象头本身是8的倍数 ， 当对象的实例数据不是8 的倍数， 便需要填充数据来保证8字节的对齐 。 

在堆上的内存分配是并发进行的 ， 虚拟机采用CAS加失败重试保证原子操作 ， 或者是采用每个线程预先分配TLAB内存

Java虚拟机规范规定这里可以抛出OutOfMemeryError

#### 方法区

方法区只要存法的是已被虚拟机加载的类信息、常量、静态变量、编译器编译后的代码等数据 。 GC在该区域出现比较少

Java虚拟机规范规定这里可以抛出OutOfMemeryError

#### 运行时常量池

运行时常量池也是方法区的一部分 ， 用于存放编译器生成的各种字面量和符号引用 。 运行时常量池除了编译器产生的Class文件的常量池 ， 还可以在运行期间， 将新的常量加进常量池 ， 比较常见的是String类的intern()方法

 - 字面量 ： 与Java语言层面的常量概念很相近， 包含文本字符串、声明为final的常量值等
 - 符号引用 ：编译语言层面的概念 ：
 	-  类和接口的全限定名
 	-  字段的名称和描述符
 	-  方法的名称和描述符

该区域不会抛出OutOfMemeryError异常